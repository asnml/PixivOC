## 这是什么？

&emsp;&emsp;PixivOC 是一个网络爬虫内核，集成了常用的操作，并设定了规范的接口供用户自定义更改或添加自己所需的操作。此外PixivOC 采用任务机制，用户可以像操作普通的下载软件一样，通过提供固定的几个值即可快速的开始自己的下载任务，而且实现了断点下载功能，让用户可以随时暂停自己的任务。



## 它有什么特点

- 远程操作：PixivOC 采用 Socket 通讯来与其他软件进行交互，这意味着你可以在服务器上部署该应用，并随时随地使用客户端来浏览下载情况。
- 境内无需翻墙即可访问：在境内是无法直接访问 Pixiv 的，该内核通过更改网站域名为IP的方式，实现了境内无需代理即可访问。
- 高性能异步下载图片：下载图片时采用了 aiohttp 库进行异步下载，用户可以通过简单的调节参数更改并发数实现改变下载速度。



## 依赖库

- requests
- aiohttp



## 怎么使用

&emsp;&emsp;**PixivOC 只是一个操作内核，并没有对其直接进行操作的方法，要使用 PixivOC 需搭配一个客户端来进行使用。库中实现了一个简易的命令行客户端，要自定义实现更加复杂的需求可自行编写客户端，客户端编写请参阅[服务器编写](#[https://github.com/asnml/PixivOC/blob/master/docs/%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%96%E5%86%99.md](https://github.com/asnml/PixivOC/blob/master/docs/服务器编写.md))。**



## 运行机制

&emsp;&emsp;PixivOC 的运行机制与传统的下载器并没有太大差别，其由 `访问令牌`+`环境变量`+`任务` 这三者组成。



### 访问令牌

&emsp;&emsp;服务器使用令牌（Token）方式来对获取访问 Pixiv 数据接口的访问权限，具体运行方式为：用户调用登陆操作提供账户和密码后，服务器请求 Pixiv 的登陆接口。若登陆成功，Pixiv 将返回 2 个值，AccessToken 和 RefreshToken，服务器将存储这两个值作为以后的访问依据。**服务器第一次启动时默认无访问令牌，在未持有访问令牌的情况下，服务器将无法创建&启动&删除任务**。

&emsp;&emsp;AccessToken 为一个短期生效的访问令牌（约1小时），访问 Pixiv 的数据接口时需附带该令牌才可正确访问。RefreshToken 为用于刷新 AccessToken 的令牌，有效期暂不清楚。



### 环境变量

- ProxyMode：代理模式，有0，1，2三个值可选择。0 为不使用任何代理，直接连接。1 为使用提供的 http 代理进行连接。2 为使用域名替换方式，以 IP 地址进行连接。中国境内用户使用该模式可以无需代理直接访问 Pixiv 网站。
- Timeout：连接超时，下载器每次进行网络请求的超时时间。该值设置的越低，超时重连机制就越有可能被频繁触发。
- ConcurrencyNumber：使用异步请求机制下载图片时，每次进行并发的网络请求数量，int 类型。若该值设置的过大且网络状况不好，那么将会出现并发请求中的多数请求被超时中断，反复进行请求的情况。
- IntervalTime：使用同步请求机制进行网络请求时，两次请求间的间隔时间，int 类型。在程序中，一般使用同步机制进行 Pixiv 的 API 请求，若该值设置的过小且请求过密，可能会出现 IP 被 ban 的情况。
- Increment：是否开启超时延长机制，bool 类型，默认 True。当完成一轮[请求周期](#)时，尚存在没有下载链接，那么在下次进行请求时，将会增大超时时间。



### 任务

&emsp;&emsp;一个任务具有以下9个属性，和开始，暂停，删除，查看详情这四种操作，具体命令可查阅[通讯接口](#https://github.com/asnml/PixivOC/blob/master/docs/通讯接口.md)。

- Over：任务是否已下载完毕，bool类型。
- TID：任务ID，int 类型。
- TaskName：任务名，字符串类型。
- TypeName：任务类型，字符串类型。PixivOC 中，用户只能创建指定类型的任务，如下载某ID的作品，查询某作品信息等。而该字段则表明该任务的类型是什么。
- StageName：阶段名，字符串类型。PixivOC 中，一个任务可能是由多个阶段（Stage）组成的，如下载某画师所有作品的任务就由查询画师所有作品跟下载图片这两个阶段组成。该字段表明了任务现在所处的阶段。
- Running：任务是否正在下载，bool 类型。
- Now：当前阶段成功进行请求的数量，int 类型。
- Total：当前阶段需要进行请求的总数量，int 类型。
- SavePath：任务存储路径，字符串类型。任务下载的图片将要保存的位置，具体保存路径将为保存路径+任务名+图片名。例如一个名为 `Test` 的任务的保存路径为 `D:\Hello` ，那么其下载的图片的路径为 `D:\Hello\Test\133250.jpg`。若任务类型为数据查询类型，无需下载图片，那么该值可为空字符串。