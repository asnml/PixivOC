# 服务器编写



## 传输服务器

### 服务器通讯方式

&emsp;&emsp;服务器与其余软件间的通讯使用 Socket 连接发送 json 字典 (Dict) 的方式进行。每次的操作请求的本质为使用 Socket 连接传输一个字节流形式的 json 字典。应用将请求字典（具体请参阅[通讯接口](#)）使用 Python 内置的 json 库编码成字符串，然后再将其进行编码为字节流后使用 Socket 连接进行传输。

&emsp;&emsp;传输流程为：PixivOC <--> Dict <--> Str <--> Bytes <--> Socket <--> ... <--> Windows Application



### 传输协议

&emsp;&emsp;为防止 Socket 粘包，应用实现了一个简易的传输协议。在每次传输实际的数据包前，先发送一个内容为 int 值，长度为 4 的数据包，int 值的内容为实际要传输的数据包的长度。



## 数据通讯

### 数据交互流程

&emsp;&emsp;数据交互流程大致分为两种，一种为服务器向发送数据，然后服务器返回数据。一种为发生了指定的事件，然后服务器主动向客户端发送数据包。为了区分两种数据包，需要用到标识号（IdentificationNumber）。

&emsp;&emsp;标识号格式为`(S|R)\d+` ，大写字母 `S` 或 `R` 称为标识头，字母后的多个数字称为识别号。标识头 `S` 代表着该请求对于发送方来说为主动发起的请求，标识头 `R` 代表该次请求为回复标识头为 `S` ，标识号与本次标识号相同的请求。例标识号 `R13225` 表示回复 请求 `S13225` 的请求。在实际应用中，客户端可使用任意数字作为标识号，服务器主动发起的请求（即标识头为 `S`）的标识号为当前时间戳。



## 客户端编写要点

&emsp;&emsp;编写一个客户端需要实现以下几个方面：

- 实现传输服务器与服务器进行通讯。
- 编写请求与返回格式的数据模型。
- 实现请求命令的发送以及返回值的处理。
- 编写处理服务器主动上报数据的函数。